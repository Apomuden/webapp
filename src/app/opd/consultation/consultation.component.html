<nz-row>
  <nz-col [nzSpan]="patient ? 24 : 16">
    <nz-card nz-row *ngIf="patient && attendance">
      <nz-collapse nzAccordion>
        <nz-collapse-panel *ngFor="let panel of panels" [nzHeader]="panel.name" [nzActive]="panel.active">
          <div *ngIf="panel.name === 'Vitals'; then vitalDetails else patientDetals"></div>
        </nz-collapse-panel>
      </nz-collapse>
    </nz-card>

    <nz-card>
      <div nz-row [nzGutter]="24" *ngIf="!patient">
        <nz-form-item nz-col [nzSpan]="6">
          <nz-form-label nzRequired nzFor="title">Folder #</nz-form-label>
          <nz-form-control nzHasFeedback nzErrorTip="Enter valid folder number">
            <input type="text" nz-input placeholder="A0000001/20a" [formControl]="folderNumb" />
          </nz-form-control>
        </nz-form-item>
      </div>

      <!-- consultation steps -->
      <nz-steps *ngIf="patient && attendance" nzSize="small" [nzProgressDot]="progressTemplate" [nzCurrent]="stepIndex">
        <nz-step nzTitle="PATIENT HISTORY"></nz-step>
        <nz-step nzTitle="PHYSICAL EXAMINATION"></nz-step>
        <nz-step nzTitle="DIAGNOSIS"></nz-step>
        <nz-step nzTitle="INVESTIGATION"></nz-step>
        <nz-step nzTitle="PRESCRIPTION"></nz-step>
        <nz-step nzTitle="PROCEDURE"></nz-step>
        <nz-step nzTitle="CLINICAL NOTES"></nz-step>
      </nz-steps>

      <ng-template #progressTemplate let-dot let-status="status" let-index="index">
        <span nz-popover nzContent="{{ status }}" style="margin-left: -100%;">
          <ng-template [ngTemplateOutlet]="dot"></ng-template>
        </span>
      </ng-template>

      <div *ngIf="patient && attendance" class="steps-content">
        <!-- patient history step -->
        <div *ngIf="stepIndex === 0">
          <nz-tabset [nzTabPosition]="'top'" nzSize="small" nzType="line">
            <nz-tab *ngIf="previousHistory" nzTitle="Previous History">
              <nz-comment nzAuthor="Presenting Complaints">
                <nz-comment-content>
                  <p>
                    {{ previousHistory.presenting_complaints }}
                  </p>
                </nz-comment-content>
              </nz-comment>

              <nz-comment nzAuthor="History of Complaints">
                <nz-comment-content>
                  <p>
                    {{ previousHistory.presenting_complaints_history }}
                  </p>
                </nz-comment-content>
              </nz-comment>

              <nz-comment nzAuthor="On Direct Questioning">
                <nz-comment-content>
                  <p>
                    {{ previousHistory.direct_questions }}
                  </p>
                </nz-comment-content>
              </nz-comment>

              <nz-comment nzAuthor="Past Medical History">
                <nz-comment-content>
                  <p>
                    {{ previousHistory.past_medical_history }}
                  </p>
                </nz-comment-content>
              </nz-comment>

              <nz-comment nzAuthor="Surgical History">
                <nz-comment-content>
                  <p>
                    {{ previousHistory.surgical_history }}
                  </p>
                </nz-comment-content>
              </nz-comment>

              <nz-comment nzAuthor="Medicine History">
                <nz-comment-content>
                  <p>
                    {{ previousHistory.medicine_history }}
                  </p>
                </nz-comment-content>
              </nz-comment>

              <nz-comment nzAuthor="Allergies History">
                <nz-comment-content>
                  <p>
                    {{ previousHistory.allergies_history }}
                  </p>
                </nz-comment-content>
              </nz-comment>

              <nz-comment nzAuthor="Family History">
                <nz-comment-content>
                  <p>
                    {{ previousHistory.family_history }}
                  </p>
                </nz-comment-content>
              </nz-comment>

              <nz-comment nzAuthor="Social History">
                <nz-comment-content>
                  <p>
                    {{ previousHistory.social_history }}
                  </p>
                </nz-comment-content>
              </nz-comment>
            </nz-tab>

            <nz-tab nzTitle="Current Entry">
              <form nz-form nzLayout="horizontal" [formGroup]="patientHistoryForm">

                <nz-form-item>
                  <nz-form-label nzRequired nzFor="religion">Relationship</nz-form-label>
                  <nz-form-control nzErrorTip="Please select relationship">
                    <nz-select nzShowSearch nzPlaceHolder="Select a relationship" formControlName="complaintRelation">
                      <nz-option *ngFor="let relationship of relationships" [nzLabel]="relationship.name"
                        [nzValue]="relationship.id">
                      </nz-option>
                    </nz-select>
                  </nz-form-control>
                </nz-form-item>

                <nz-form-item nz-row>
                  <nz-form-label nzFor="presentComplaints">Presenting Complaints <button nz-button nzType="primary"
                      nzShape="circle"><i nz-icon nzType="edit" nzTheme="twotone"></i></button></nz-form-label>
                  <nz-form-control>
                    <textarea formControlName="presentComplaints" nz-input placeholder="Enter findings here"></textarea>
                  </nz-form-control>
                </nz-form-item>

                <nz-form-item nz-row>
                  <nz-form-label nzFor="historyComplaints">History of Complaints <button nz-button nzType="primary"
                      nzShape="circle"><i nz-icon nzType="edit" nzTheme="twotone"></i></button></nz-form-label>
                  <nz-form-control>
                    <textarea formControlName="historyComplaints" nz-input placeholder="Enter findings here"></textarea>
                  </nz-form-control>
                </nz-form-item>

                <nz-form-item nz-row>
                  <nz-form-label nzFor="directQuestioning">On Direct Questioning <button nz-button nzType="primary"
                      nzShape="circle"><i nz-icon nzType="edit" nzTheme="twotone"></i></button></nz-form-label>
                  <nz-form-control>
                    <textarea formControlName="directQuestioning" nz-input placeholder="Enter findings here"></textarea>
                  </nz-form-control>
                </nz-form-item>

                <nz-form-item nz-row>
                  <nz-form-label nzFor="pastMedicalHistory">Past Medical History <button nz-button nzType="primary"
                      nzShape="circle"><i nz-icon nzType="edit" nzTheme="twotone"></i></button></nz-form-label>
                  <nz-form-control>
                    <textarea formControlName="pastMedicalHistory" nz-input
                      placeholder="Enter findings here"></textarea>
                  </nz-form-control>
                </nz-form-item>

                <nz-form-item nz-row>
                  <nz-form-label nzFor="medicineHistory">Medicine History <button nz-button nzType="primary"
                      nzShape="circle"><i nz-icon nzType="edit" nzTheme="twotone"></i></button></nz-form-label>
                  <nz-form-control>
                    <textarea formControlName="medicineHistory" nz-input placeholder="Enter findings here"></textarea>
                  </nz-form-control>
                </nz-form-item>

                <nz-form-item nz-row>
                  <nz-form-label nzFor="surgicalHistory">Surgical History <button nz-button nzType="primary"
                      nzShape="circle"><i nz-icon nzType="edit" nzTheme="twotone"></i></button></nz-form-label>
                  <nz-form-control>
                    <textarea formControlName="surgicalHistory" nz-input placeholder="Enter findings here"></textarea>
                  </nz-form-control>
                </nz-form-item>

                <nz-form-item nz-row>
                  <nz-form-label nzFor="allergiesHistory">Allergy History <button nz-button nzType="primary"
                      nzShape="circle"><i nz-icon nzType="edit" nzTheme="twotone"></i></button></nz-form-label>
                  <nz-form-control>
                    <textarea formControlName="allergiesHistory" nz-input placeholder="Enter findings here"></textarea>
                  </nz-form-control>
                </nz-form-item>

                <nz-form-item nz-row>
                  <nz-form-label nzFor="familyHistory">Family History <button nz-button nzType="primary"
                      nzShape="circle"><i nz-icon nzType="edit" nzTheme="twotone"></i></button></nz-form-label>
                  <nz-form-control>
                    <textarea formControlName="familyHistory" nz-input placeholder="Enter findings here"></textarea>
                  </nz-form-control>
                </nz-form-item>

                <nz-form-item nz-row>
                  <nz-form-label nzFor="socialHistory">Social History <button nz-button nzType="primary"
                      nzShape="circle"><i nz-icon nzType="edit" nzTheme="twotone"></i></button></nz-form-label>
                  <nz-form-control>
                    <textarea formControlName="socialHistory" nz-input placeholder="Enter findings here"></textarea>
                  </nz-form-control>
                </nz-form-item>
              </form>
            </nz-tab>
          </nz-tabset>
        </div>


        <nz-row nzType="flex" nzJustify="center">
          <nz-col>
            <nz-button-group>
              <button *ngIf="stepIndex === 0" nz-button nzType="danger" (click)="cancel()"
                [nzLoading]="submiting">Cancel</button>
              <button *ngIf="stepIndex > 0" nz-button (click)="previous()" [nzLoading]="submiting">Previous</button>

              <button *ngIf="stepIndex < stepsCount" nz-button (click)="next()" [nzLoading]="submiting">Next</button>
              <button *ngIf="stepIndex === stepsCount" nz-button nzType="primary" (click)="done()"
                [nzLoading]="submiting">Done</button>
            </nz-button-group>
          </nz-col>
        </nz-row>
      </div>
      <!-- <nz-table *ngIf="patient && attendance" nzTemplateMode nzBordered nzSize="small">
        <thead>
          <tr>
            <th nzWidth="34%">Vital</th>
            <th nzWidth="33%">Value</th>
            <th nzWidth="33%">Flag</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let vital of vitals" class="editable-row">
            <td>
              {{vital.name}}
            </td>
            <td>
              <div class="editable-cell" *ngIf="editName !== vital.name; else editTpl">
                <div class="editable-cell-value-wrap" (click)="startEdit(vital.name, $event)">
                  <span *ngIf="vital.name !== 'BMI'">
                    {{ (vital.form.value != null && vital.form.valid) ? vital.form.value + ' ' + vital.unit : 'Click to enter value' }}
                  </span>
                  <span *ngIf="vital.name === 'BMI'">
                    {{ (vital.form.value) ? vital.form.value + ' ' + vital.unit : 'Enter valid height and weight to evaluate' }}
                  </span>
                </div>
              </div>
              <ng-template #editTpl>
                <input nz-input [placeholder]="(vital.name === 'Blood Pressure' ? 'eg: 70/109': 'eg: 10')"
                  [type]="(vital.name === 'Blood Pressure') ? 'text': 'number'" [formControl]="vital.form" />
              </ng-template>
            </td>

            <td>{{ vital.flag }}</td>
          </tr>
          <tr>
            <td [attr.colspan]="3">
              <nz-form-control>
                <textarea [formControl]="commentControl" nz-input placeholder="Extra comments"></textarea>
              </nz-form-control>
            </td>
          </tr>

          <tr>
            <td [attr.colspan]="3">
              <nz-row nzJustify="center" nzType="flex">
                <nz-col>
                  <nz-button-group>
                    <button nz-button nzType="danger" (click)="cancel()" [nzLoading]="submiting">Cancel</button>
                    <button nz-button nzType="primary" (click)="done()"
                      [nzLoading]="submiting">Done</button>
                  </nz-button-group>
                </nz-col>
              </nz-row>
            </td>
          </tr>

        </tbody>
      </nz-table> -->

      <nz-divider></nz-divider>
      <div nz-row>
        <div nz-col nzSpan="12" nzOffset="6" nzSm="24" *ngIf="!searchInitialized"><i nz-icon [nzType]="'info-circle'"
            class="m-r-5"></i> {{message}}
        </div>
      </div>

      <nz-row>
        <nz-skeleton [nzLoading]="isLoadingData && searchInitialized" [nzActive]="true">
        </nz-skeleton>
      </nz-row>

    </nz-card>
  </nz-col>

  <nz-col *ngIf="!patient" [nzSpan]="8">
    <app-patient-queue *ngIf="today" [queuePath]="'/registry/attendance?attendance_date=' + today" action="Consult"
      (queueClick)="attendanceClick($event)"></app-patient-queue>
  </nz-col>
</nz-row>

<ng-template #vitalDetails>
  <nz-descriptions *ngIf="vitals" nzSize="small" nzBordered>
    <nz-descriptions-item *ngFor="let key of vitalKeys" [nzTitle]="key.name">
      <span *ngIf="vitals[key.apiName] && vitals[key.apiName].value">
        {{ vitals[key.apiName].value }}
        {{ vitals[key.apiName].unit }}</span>
      <span *ngIf="!vitals[key.apiName] || !vitals[key.apiName].value"> N/A </span>
    </nz-descriptions-item>
  </nz-descriptions>

  <nz-comment nzAuthor="Nurse Comments" *ngIf="vitals && vitals.comment">
    <nz-comment-content>
      <p>
        {{ vitals.comment }}
      </p>
    </nz-comment-content>
  </nz-comment>
</ng-template>

<ng-template #patientDetals>
  <nz-descriptions *ngIf="patient && attendance" nzSize="small" nzBordered
    [nzColumn]="{ xxl: 4, xl: 3, lg: 3, md: 3, sm: 2, xs: 1 }">
    <nz-descriptions-item nzTitle="Folder #">
      {{patient.folder_no}}
    </nz-descriptions-item>
    <nz-descriptions-item nzTitle="Name">
      {{patient.firstname}} {{patient.middlename}} {{patient.surname}}
    </nz-descriptions-item>
    <nz-descriptions-item nzTitle="Gender">
      {{patient.gender}}
    </nz-descriptions-item>
    <nz-descriptions-item nzTitle="Age">
      {{attendance.age}} year(s)
    </nz-descriptions-item>
    <nz-descriptions-item *ngIf="attendance" nzTitle="Funding Type">
      {{attendance.funding_type_name}}
    </nz-descriptions-item>
    <nz-descriptions-item *ngIf="attendance" nzTitle="Patient Status">
      {{attendance.patient_status}}
    </nz-descriptions-item>
    <nz-descriptions-item *ngIf="attendance" nzTitle="Clinic">
      {{attendance.clinic_name}}
    </nz-descriptions-item>
    <nz-descriptions-item *ngIf="attendance" nzTitle="Attendance Date">
      {{attendance.attendance_date | date}}
    </nz-descriptions-item>
  </nz-descriptions>
</ng-template>